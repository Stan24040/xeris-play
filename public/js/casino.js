const XERIS_API='http://138.197.116.81:50008';
const XERIS_NET='http://138.197.116.81:56001';
const LAMPORTS_PER_XRS=1000000000;
async function mnemonicToSeed(m){const e=new TextEncoder();const k=await crypto.subtle.importKey('raw',e.encode(m.normalize('NFKD')),'PBKDF2',false,['deriveBits']);const b=await crypto.subtle.deriveBits({name:'PBKDF2',salt:e.encode('mnemonic'.normalize('NFKD')),iterations:2048,hash:'SHA-512'},k,512);return new Uint8Array(b);}
async function hmac512(key,data){const k=await crypto.subtle.importKey('raw',key,{name:'HMAC',hash:'SHA-512'},false,['sign']);return new Uint8Array(await crypto.subtle.sign('HMAC',k,data));}
async function deriveChild(key,chain,idx){const buf=new Uint8Array(37);buf[0]=0;buf.set(key,1);new DataView(buf.buffer).setUint32(33,idx+0x80000000,false);const r=await hmac512(chain,buf);return{key:r.slice(0,32),chain:r.slice(32)};}
async function deriveSolanaKeypair(mnemonic){const seed=await mnemonicToSeed(mnemonic.trim().toLowerCase());let r=await hmac512(new TextEncoder().encode('ed25519 seed'),seed);let key=r.slice(0,32),chain=r.slice(32);for(const i of[44,501,0,0]){const c=await deriveChild(key,chain,i);key=c.key;chain=c.chain;}return nacl.sign.keyPair.fromSeed(key);}
const XerisWallet={keypair:null,async fromSeedPhrase(m){const words=m.trim().split(/\s+/);if(words.length!==12&&words.length!==24)throw new Error('Must be 12 or 24 words');const kp=await deriveSolanaKeypair(m);this.keypair=kp;this._save(kp);return kp;},generateKeypair(){const kp=nacl.sign.keyPair();this.keypair=kp;this._save(kp);return kp;},loadFromSession(){try{const s=sessionStorage.getItem('xrs_wallet');if(!s)return null;const kp=nacl.sign.keyPair.fromSecretKey(new Uint8Array(JSON.parse(s).secretKey));this.keypair=kp;return kp;}catch{return null;}},_save(kp){sessionStorage.setItem('xrs_wallet',JSON.stringify({secretKey:Array.from(kp.secretKey)}));},getAddress(){return this.keypair?bs58.encode(this.keypair.publicKey):null;},disconnect(){this.keypair=null;sessionStorage.removeItem('xrs_wallet');},async getBalance(addr){const a=addr||this.getAddress();if(!a)return 0;try{const r=await fetch('/api/balance/'+a);const d=await r.json();return d.balance||0;}catch{return 0;}},toXRS(l){return(l/LAMPORTS_PER_XRS).toFixed(4);},toLamports(x){return Math.floor(parseFloat(x)*LAMPORTS_PER_XRS);},async buildSignedTx(to,amt){if(!this.keypair)throw new Error('Not connected');const r=await fetch(XERIS_API+'/rpc',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({jsonrpc:'2.0',id:1,method:'getLatestBlockhash',params:[]})});const d=await r.json();const blockhash=d.result?.blockhash??d.result;const tx={recentBlockhash:blockhash,instructions:[{from:this.getAddress(),to,amount:amt}]};const msg=new TextEncoder().encode(JSON.stringify(tx));const sig=nacl.sign.detached(msg,this.keypair.secretKey);return btoa(JSON.stringify({...tx,signature:btoa(String.fromCharCode(...sig)),publicKey:this.getAddress()}));},async sendToTreasury(addr,xrs){const tx=await this.buildSignedTx(addr,this.toLamports(xrs));const r=await fetch(XERIS_NET+'/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tx_base64:tx})});const d=await r.json();const s=d?.signature??d?.result??d?.id??null;if(!s)throw new Error('TX failed: '+JSON.stringify(d));return s;},async requestFaucet(amt=10){const r=await fetch('/api/faucet',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:this.getAddress(),amount:amt})});return r.json();}};
const WalletUI={async init(cb){this.cb=cb;if(XerisWallet.loadFromSession()){await this.ready();return;}this.modal();},modal(){document.getElementById('wallet-modal')?.remove();const m=document.createElement('div');m.id='wallet-modal';m.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';m.innerHTML='<div style="background:#0d0d1a;border:1px solid #c8ff00;border-radius:16px;padding:28px;max-width:440px;width:100%;color:#fff;"><h2 style="color:#c8ff00;margin:0 0 16px;">Connect Wallet</h2><p style="color:#888;margin:0 0 8px;font-size:13px;">Enter your 12 or 24-word seed phrase:</p><textarea id="si" rows="4" placeholder="word1 word2 word3 ..." style="width:100%;padding:12px;background:#111;border:1px solid #333;border-radius:8px;color:#fff;font-size:13px;resize:none;box-sizing:border-box;font-family:monospace;margin-bottom:8px;"></textarea><button id="bs" style="width:100%;padding:14px;background:#c8ff00;color:#000;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-bottom:12px;">Connect with Seed Phrase</button><button id="bg" style="width:100%;padding:11px;background:#0a0a18;color:#c8ff00;border:1px solid #c8ff00;border-radius:8px;font-weight:600;cursor:pointer;">‚ö° Generate New Wallet</button><p style="color:#444;font-size:11px;margin:12px 0 0;text-align:center;">Seed phrase never sent to server.</p><div id="we" style="color:#ff4444;font-size:13px;margin-top:8px;display:none;"></div></div>';document.body.appendChild(m);document.getElementById('bs').onclick=async()=>{const mn=document.getElementById('si').value.trim();const err=document.getElementById('we');const btn=document.getElementById('bs');if(!mn)return;btn.disabled=true;btn.textContent='Deriving...';err.style.display='none';try{await XerisWallet.fromSeedPhrase(mn);m.remove();await this.ready();}catch(e){err.textContent='‚ùå '+e.message;err.style.display='block';btn.disabled=false;btn.textContent='Connect with Seed Phrase';}};document.getElementById('bg').onclick=async()=>{XerisWallet.generateKeypair();m.remove();await this.ready();};},async ready(){const addr=XerisWallet.getAddress();const bal=await XerisWallet.getBalance();this.bar(addr,bal);if(this.cb)this.cb({address:addr,balance:bal});},bar(addr,bal){let b=document.getElementById('wallet-bar');if(!b){b=document.createElement('div');b.id='wallet-bar';b.style.cssText='position:fixed;top:0;left:0;right:0;background:#07070f;border-bottom:1px solid #1a1a2e;padding:8px 16px;display:flex;align-items:center;justify-content:space-between;z-index:1000;font-size:13px;';document.body.style.paddingTop='48px';document.body.prepend(b);}const s=addr?addr.slice(0,6)+'...'+addr.slice(-4):'';b.innerHTML='<span style="color:#c8ff00;font-weight:700;">XERIS.PLAY</span><div style="display:flex;gap:10px;align-items:center;"><span id="wb" style="color:#aaa;">'+XerisWallet.toXRS(bal)+' XRS</span><span style="background:#111;border:1px solid #2a2a3a;padding:5px 12px;border-radius:20px;color:#fff;cursor:pointer;font-size:12px;" onclick="WalletUI.details()">'+s+'</span><button onclick="WalletUI.faucet()" style="background:transparent;border:1px solid #c8ff00;color:#c8ff00;padding:5px 10px;border-radius:20px;cursor:pointer;font-size:11px;">Faucet</button></div>';},async refreshBalance(){const b=await XerisWallet.getBalance();const el=document.getElementById('wb');if(el)el.textContent=XerisWallet.toXRS(b)+' XRS';return b;},details(){const addr=XerisWallet.getAddress();const m=document.createElement('div');m.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';m.innerHTML='<div style="background:#0d0d1a;border:1px solid #333;border-radius:16px;padding:24px;max-width:400px;width:100%;color:#fff;"><h3 style="color:#c8ff00;margin:0 0 12px;">Wallet</h3><p style="font-size:12px;word-break:break-all;background:#111;padding:10px;border-radius:8px;cursor:pointer;margin:0 0 12px;" onclick="navigator.clipboard.writeText(\''+addr+'\').then(()=>alert(\'Copied!\'))">'+addr+' üìã</p><a href="http://138.197.116.81:50008/v2/account/'+addr+'" target="_blank" style="display:block;color:#c8ff00;font-size:13px;margin-bottom:16px;">üîç Explorer ‚Üí</a><div style="display:flex;gap:8px;"><button onclick="this.closest(\'div[style]\').remove()" style="flex:1;padding:10px;background:#111;border:1px solid #333;color:#fff;border-radius:8px;cursor:pointer;">Close</button><button onclick="XerisWallet.disconnect();sessionStorage.clear();location.reload()" style="flex:1;padding:10px;background:#1a0a0a;border:1px solid #ff4444;color:#ff4444;border-radius:8px;cursor:pointer;">Disconnect</button></div></div>';document.body.appendChild(m);m.addEventListener('click',e=>{if(e.target===m)m.remove();});},async faucet(){if(!confirm('Request 10 XRS?'))return;try{const r=await XerisWallet.requestFaucet(10);alert(JSON.stringify(r));await this.refreshBalance();}catch(e){alert(e.message);}}};
const Casino={treasury:null,async init(){try{const r=await fetch('/api/treasury');this.treasury=await r.json();}catch(e){console.error(e);}},async placeBet({game,betAmountXRS,betType,betValue}){if(!XerisWallet.keypair)throw new Error('Not connected');if(!this.treasury?.address)throw new Error('No treasury');const lam=XerisWallet.toLamports(betAmountXRS);const bal=await XerisWallet.getBalance();if(bal<lam)throw new Error('Insufficient balance');const sig=await XerisWallet.sendToTreasury(this.treasury.address,betAmountXRS);const r=await fetch('/api/bet',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({playerAddress:XerisWallet.getAddress(),betTxSignature:sig,betAmount:lam,game,betType,betValue})});const d=await r.json();if(!d.success)throw new Error(d.error||'Failed');await WalletUI.refreshBalance();return d;},txLinksHTML(b,p){const base='http://138.197.116.81:50008/v2/tx/';return '<div style="margin-top:12px;padding:10px;background:#0a0a18;border-radius:8px;border:1px solid #1a1a2e;font-size:12px;"><p style="color:#888;margin:0 0 6px;">üîó On-chain proof:</p><a href="'+base+b+'" target="_blank" style="display:block;color:#c8ff00;margin-bottom:4px;">‚Üó Bet TX</a>'+(p?'<a href="'+base+p+'" target="_blank" style="display:block;color:#00ff88;">‚Üó Payout TX</a>':'')+'</div>';}};
